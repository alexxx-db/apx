name: CI

on:
  pull_request:

env:
  CARGO_TERM_COLOR: always
  PROTOC_VERSION: "28.3"

jobs:
  check:
    runs-on: linux-ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.88.0"
          components: rustfmt, clippy

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      # Cache Cargo dependencies aggressively
      - name: Cache Cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo build
        uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-cargo-target-

      # Install protoc (required for prost-build)
      - name: Cache Protoc
        id: cache-protoc
        uses: actions/cache@v5
        with:
          path: .protoc
          key: protoc-${{ runner.os }}-${{ runner.arch }}-${{ env.PROTOC_VERSION }}

      - name: Download Protoc
        if: steps.cache-protoc.outputs.cache-hit != 'true'
        run: uv run --script scripts/download_protoc.py --version ${{ env.PROTOC_VERSION }} --output-dir .protoc

      - name: Setup Protoc environment
        run: |
          echo "${{ github.workspace }}/.protoc/bin" >> $GITHUB_PATH
          echo "PROTOC=${{ github.workspace }}/.protoc/bin/protoc" >> $GITHUB_ENV

      # Download Binaries (Bun)
      - name: Cache Bun binaries
        id: cache-bun-binaries
        uses: actions/cache@v5
        with:
          path: .bins/bun
          key: bun-binaries-${{ hashFiles('scripts/get_binaries.py') }}

      - name: Download binaries
        if: steps.cache-bun-binaries.outputs.cache-hit != 'true'
        run: uv run --script scripts/get_binaries.py

      # Build apx-agent binary (cached based on crate source files)
      - name: Cache apx-agent binary
        id: cache-agent
        uses: actions/cache@v5
        with:
          path: .bins/agent
          key: apx-agent-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('crates/agent/**', 'crates/common/**', 'Cargo.lock') }}

      - name: Build apx-agent
        if: steps.cache-agent.outputs.cache-hit != 'true'
        run: uv run --script scripts/build_agent.py --target x86_64-unknown-linux-gnu

      # Run checks
      - name: Cargo check
        run: cargo check --all-targets

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --all-targets -- -D warnings

      - name: Cargo test
        run: cargo test --workspace
