name: CI

on:
  pull_request:

env:
  CARGO_TERM_COLOR: always
  PROTOC_VERSION: "28.3"

jobs:
  check:
    runs-on: linux-ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.88.0"
          components: rustfmt, clippy

      # Cache Cargo dependencies aggressively
      - name: Cache Cargo registry
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-

      - name: Cache Cargo build
        uses: actions/cache@v5
        with:
          path: target
          key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-cargo-target-

      # Install protoc (required for prost-build)
      - name: Cache Protoc
        id: cache-protoc
        uses: actions/cache@v5
        with:
          path: .protoc
          key: protoc-${{ runner.os }}-${{ runner.arch }}-${{ env.PROTOC_VERSION }}

      - name: Install uv
        if: steps.cache-protoc.outputs.cache-hit != 'true'
        uses: astral-sh/setup-uv@v7

      - name: Download Protoc
        if: steps.cache-protoc.outputs.cache-hit != 'true'
        run: uv run --script scripts/download_protoc.py --version ${{ env.PROTOC_VERSION }} --output-dir .protoc

      - name: Setup Protoc environment
        run: |
          echo "${{ github.workspace }}/.protoc/bin" >> $GITHUB_PATH
          echo "PROTOC=${{ github.workspace }}/.protoc/bin/protoc" >> $GITHUB_ENV

      # Run checks
      - name: Cargo check
        run: cargo check --all-targets

      - name: Cargo fmt
        run: cargo fmt --all -- --check

      - name: Cargo clippy
        run: cargo clippy --all-targets -- -D warnings
